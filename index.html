<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gest√£o Dom√©stica Pro v5.1</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f2f5; --surface: #ffffff;
    --primary: #0f172a; --accent: #3b82f6;
    --text: #334155; --text-light: #64748b;
    --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
    --border: #e2e8f0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; font-size: 14px; }

  /* LAYOUT */
  aside { width: 260px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
  main { flex: 1; overflow-y: auto; padding: 30px; }
  
  /* NAV & HEADER */
  .brand { padding: 24px; font-size: 18px; font-weight: 800; color: var(--primary); border-bottom: 1px solid var(--border); letter-spacing: -0.5px; }
  .nav-item { display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px 20px; color: var(--text-light); border: none; background: transparent; cursor: pointer; font-weight: 500; transition: 0.2s; text-align: left; margin-bottom: 2px; }
  .nav-item:hover { background: #f1f5f9; color: var(--primary); }
  .nav-item.active { background: #e0f2fe; color: var(--accent); font-weight: 600; border-right: 3px solid var(--accent); }
  
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .page-title { font-size: 24px; font-weight: 700; color: var(--primary); letter-spacing: -0.5px; }

  /* CARDS & GRID */
  .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .card { background: var(--surface); border-radius: 12px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  .card h3 { font-size: 15px; font-weight: 600; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

  /* METRICS */
  .kpi { padding: 20px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); position: relative; overflow: hidden; }
  .kpi-lbl { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-light); margin-bottom: 6px; }
  .kpi-val { font-size: 26px; font-weight: 700; color: var(--primary); letter-spacing: -1px; }
  .kpi-sub { font-size: 13px; margin-top: 4px; color: var(--text-light); }
  .kpi-tag { position: absolute; top: 15px; right: 15px; font-size: 20px; opacity: 0.2; }

  /* FORMS & TABLES */
  .row { display: flex; gap: 15px; margin-bottom: 15px; }
  .row > div { flex: 1; }
  label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text); }
  input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; color: var(--primary); }
  input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
  
  .btn { width: 100%; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #1e293b; }
  .btn-sm { width: auto; padding: 8px 16px; font-size: 13px; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 12px; background: #f8fafc; color: var(--text-light); font-weight: 600; border-bottom: 1px solid var(--border); }
  td { padding: 12px; border-bottom: 1px solid var(--border); color: var(--text); }
  
  .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
  .bg-green { background: #dcfce7; color: #166534; }
  .bg-yellow { background: #fef9c3; color: #854d0e; }
  .bg-red { background: #fee2e2; color: #ef4444; }

  /* FINANCE */
  .fin-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px dashed var(--border); }
  .fin-row:last-child { border-bottom: none; }
  .fin-total { font-weight: 700; font-size: 16px; color: var(--primary); border-top: 2px solid var(--border); margin-top: 10px; padding-top: 10px; border-bottom: none; }
  .text-red { color: var(--danger); }
  .text-blue { color: var(--accent); }
  
  /* UTILS */
  .hidden { display: none !important; }
  #loader, #login { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
</style>
</head>
<body>

<div id="loader" class="hidden"><div style="font-size:30px;animation:spin 1s infinite linear">‚è≥</div><p>Sincronizando...</p></div>
<div id="login">
  <div style="width:360px; text-align:center">
    <h2 style="margin-bottom:10px">üîê Gest√£o Dom√©stica</h2>
    <p style="color:#64748b; margin-bottom:20px; font-size:13px">Cole a URL do Google Apps Script.</p>
    <input type="text" id="api-url" placeholder="https://script.google.com/..." style="margin-bottom:15px">
    <button class="btn btn-primary" onclick="connect()">Conectar</button>
  </div>
</div>

<aside id="sidebar" class="hidden">
  <div class="brand">üõ°Ô∏è Gest√£o Dom√©stica</div>
  <nav>
    <button class="nav-item active" onclick="nav('dashboard')" data-t="dashboard">üìä Vis√£o Geral</button>
    <button class="nav-item" onclick="nav('pagamentos')" data-t="pagamentos">üí∞ Folha Pagamento</button>
    <button class="nav-item" onclick="nav('horas')" data-t="horas">‚è±Ô∏è Banco de Horas</button>
    <button class="nav-item" onclick="nav('ferias')" data-t="ferias">üå¥ F√©rias</button>
    <button class="nav-item" onclick="nav('decimo')" data-t="decimo">üéÅ 13¬∫ Sal√°rio</button>
    <button class="nav-item" onclick="nav('rescisao')" data-t="rescisao">‚ö†Ô∏è Rescis√£o</button>
    <button class="nav-item" onclick="nav('config')" data-t="config">‚öôÔ∏è Configura√ß√µes</button>
  </nav>
  <div style="margin-top:auto; padding:20px; font-size:11px; color:#94a3b8; text-align:center">
    v5.1 (Completa)
    <br><a href="#" onclick="logout()" style="color:var(--danger)">Sair</a>
  </div>
</aside>

<main id="app" class="hidden">

  <div id="view-dashboard" class="view">
    <div class="header">
      <div class="page-title">Painel de Controle</div>
      <button class="btn btn-primary btn-sm" onclick="init()">üîÑ Atualizar</button>
    </div>

    <div class="grid-3">
      <div class="kpi">
        <div class="kpi-lbl">Custo Total (M√™s Atual)</div>
        <div class="kpi-val" id="kpi-custo">R$ 0,00</div>
        <div class="kpi-sub">Sal√°rio + Impostos + HE</div>
        <div class="kpi-tag">üìâ</div>
      </div>
      <div class="kpi">
        <div class="kpi-lbl">Guia DAE Estimada</div>
        <div class="kpi-val" style="color:var(--warning)" id="kpi-dae">R$ 0,00</div>
        <div class="kpi-sub" id="lbl-vencimento">Vence dia 07</div>
        <div class="kpi-tag">üèõÔ∏è</div>
      </div>
      <div class="kpi">
        <div class="kpi-lbl">HE Pendentes</div>
        <div class="kpi-val" id="kpi-he">0</div>
        <div class="kpi-sub" id="kpi-he-val">R$ 0,00</div>
        <div class="kpi-tag">‚è±Ô∏è</div>
      </div>
    </div>

    <div class="card">
      <h3>üìã Previs√£o Financeira (M√™s Atual)</h3>
      <div class="grid-2">
        <div>
          <h4 style="font-size:13px; color:var(--text-light); margin-bottom:10px">A PAGAR (FUNCION√ÅRIA)</h4>
          <div class="fin-row"><span>Sal√°rio Base</span><span id="d-sal">R$ 0,00</span></div>
          <div class="fin-row"><span>+ Horas Extras</span><span id="d-he">R$ 0,00</span></div>
          <div class="fin-row"><span>+ Reflexo DSR</span><span id="d-dsr">R$ 0,00</span></div>
          <div class="fin-row text-red"><span>- INSS (Retido)</span><span id="d-inss">R$ 0,00</span></div>
          <div class="fin-row text-red"><span>- IRRF (Retido)</span><span id="d-irrf">R$ 0,00</span></div>
          <div class="fin-row fin-total"><span>L√≠quido:</span><span id="d-pagar">R$ 0,00</span></div>
        </div>
        <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px dashed var(--border)">
          <h4 style="font-size:13px; color:var(--text-light); margin-bottom:10px">A PAGAR (GOVERNO - DAE)</h4>
          <div class="fin-row"><span>FGTS (8%)</span><span id="d-fgts">R$ 0,00</span></div>
          <div class="fin-row"><span>Multa FGTS (3.2%)</span><span id="d-fgts-comp">R$ 0,00</span></div>
          <div class="fin-row"><span>INSS Patronal (8%)</span><span id="d-patr">R$ 0,00</span></div>
          <div class="fin-row"><span>Seguro (0.8%)</span><span id="d-gilrat">R$ 0,00</span></div>
          <div class="fin-row text-blue"><span>+ Repasse INSS Func.</span><span id="d-rep-inss">R$ 0,00</span></div>
          <div class="fin-row fin-total" style="color:var(--warning)"><span>Total Guia:</span><span id="d-total-dae">R$ 0,00</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="view-pagamentos" class="view hidden">
    <div class="header"><div class="page-title">Folha de Pagamento</div></div>
    <div class="grid-2">
      <div class="card">
        <h3>Lan√ßar M√™s</h3>
        <div class="row">
          <div><label>M√™s</label><select id="p-mes"><option value="1">Jan</option><option value="2">Fev</option><option value="3">Mar</option><option value="4">Abr</option><option value="5">Mai</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Ago</option><option value="9">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select></div>
          <div><label>Ano</label><input type="number" id="p-ano" value="2026"></div>
        </div>
        <div class="row">
          <div><label>HE 50% (min)</label><input type="number" id="p-h50" value="0" oninput="simula()"></div>
          <div><label>HE 100% (min)</label><input type="number" id="p-h100" value="0" oninput="simula()"></div>
        </div>
        <div class="row">
          <div><label>Dias √öteis</label><input type="number" id="p-uteis" value="25" oninput="simula()"></div>
          <div><label>Dom/Fer</label><input type="number" id="p-dsr" value="5" oninput="simula()"></div>
        </div>
        <div class="row">
          <div><label>Faltas (R$)</label><input type="number" id="p-falta" value="0" step="0.01" oninput="simula()"></div>
          <div><label>Adiantamento (R$)</label><input type="number" id="p-adiant" value="0" step="0.01" oninput="simula()"></div>
        </div>
        <button class="btn btn-primary" onclick="saveFolha()">üíæ Salvar Pagamento</button>
      </div>
      <div class="card" style="background:#f1f5f9">
        <h3>Pr√©via do Holerite</h3>
        <div class="fin-row"><span>Sal√°rio Base</span><span id="h-sal">R$ 0,00</span></div>
        <div class="fin-row"><span>H.Extras + DSR</span><span id="h-he">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- Faltas</span><span id="h-fal">R$ 0,00</span></div>
        <div style="border-bottom:1px solid #ccc; margin:5px 0"></div>
        <div class="fin-row"><span>Base Calc. INSS</span><span id="h-base" style="font-weight:bold">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- INSS</span><span id="h-inss">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- IRRF</span><span id="h-irrf">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- Adiantamento</span><span id="h-adiant">R$ 0,00</span></div>
        <div class="fin-row fin-total"><span>L√≠quido:</span><span id="h-liq">R$ 0,00</span></div>
      </div>
    </div>
    <div class="card" style="margin-top:20px">
      <h3>Hist√≥rico</h3>
      <table id="tb-pag"><thead><tr><th>Data</th><th>Bruto</th><th>Desc.</th><th>L√≠quido</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-horas" class="view hidden">
    <div class="header"><div class="page-title">Banco de Horas</div></div>
    <div class="grid-2">
      <div class="card">
        <h3>Registrar Hora Extra</h3>
        <div class="row">
          <div><label>Data</label><input type="date" id="he-data"></div>
          <div><label>Minutos</label><input type="number" id="he-min" placeholder="Ex: 60"></div>
        </div>
        <div class="row">
           <div><label>Tipo</label><select id="he-tipo"><option value="50">50% (Normal)</option><option value="100">100% (Dom/Fer)</option></select></div>
        </div>
        <label>Motivo</label><input type="text" id="he-motivo" placeholder="Ex: Atraso sa√≠da" style="margin-bottom:15px">
        <button class="btn btn-primary" onclick="saveHE()">Registrar</button>
      </div>
      <div class="card">
         <h3>Valores Refer√™ncia</h3>
         <div class="fin-row"><span>Hora Normal</span><span id="ref-hn">R$ 0,00</span></div>
         <div class="fin-row"><span>Hora 50%</span><span id="ref-h50">R$ 0,00</span></div>
         <div class="fin-row"><span>Hora 100%</span><span id="ref-h100">R$ 0,00</span></div>
      </div>
    </div>
    <div class="card" style="margin-top:20px">
      <h3>Pendentes</h3>
      <table id="tb-he"><thead><tr><th>Data</th><th>Tipo</th><th>Tempo</th><th>Valor</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-ferias" class="view hidden">
    <div class="header"><div class="page-title">Calculadora de F√©rias</div></div>
    <div class="grid-2">
        <div class="card">
            <h3>Simular F√©rias</h3>
            <div class="row">
                <div><label>Dias de Gozo</label><input type="number" id="f-dias" value="30" oninput="simFerias()"></div>
                <div><label>Vender 10 dias?</label><select id="f-abono" onchange="simFerias()"><option value="nao">N√£o</option><option value="sim">Sim</option></select></div>
            </div>
            <div class="row">
                <div><label>M√©dia HE (R$)</label><input type="number" id="f-media" value="0" placeholder="M√©dia √∫ltimos 12 meses" oninput="simFerias()"></div>
            </div>
            
            <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-top:10px">
                <div class="fin-row"><span>Base (Sal+M√©dia)</span><span id="rf-base">R$ 0,00</span></div>
                <div class="fin-row"><span>F√©rias + 1/3</span><span id="rf-ferias">R$ 0,00</span></div>
                <div class="fin-row"><span>Abono + 1/3</span><span id="rf-abono">R$ 0,00</span></div>
                <div class="fin-row text-red"><span>- INSS</span><span id="rf-inss">R$ 0,00</span></div>
                <div class="fin-row text-red"><span>- IRRF</span><span id="rf-irrf">R$ 0,00</span></div>
                <div class="fin-row fin-total"><span>L√≠quido:</span><span id="rf-liq">R$ 0,00</span></div>
            </div>
            <button class="btn btn-primary" style="margin-top:15px" onclick="saveFerias()">Registrar F√©rias</button>
        </div>
        <div class="card">
            <h3>Hist√≥rico de F√©rias</h3>
            <table id="tb-ferias"><thead><tr><th>In√≠cio</th><th>Dias</th><th>L√≠quido</th><th>Status</th></tr></thead><tbody><tr><td colspan="4" style="text-align:center;color:#999">Sem registros</td></tr></tbody></table>
        </div>
    </div>
  </div>

  <div id="view-decimo" class="view hidden">
    <div class="header"><div class="page-title">13¬∫ Sal√°rio</div></div>
    <div class="card" style="max-width:600px">
        <h3>Calculadora 13¬∫</h3>
        <div class="row">
            <div><label>Parcela</label><select id="d13-parc" onchange="calcD13()"><option value="1">1¬™ Parcela (Nov - Sem desc.)</option><option value="2">2¬™ Parcela (Dez - Com desc.)</option></select></div>
            <div><label>Meses Trab.</label><input type="number" id="d13-meses" value="12" oninput="calcD13()"></div>
        </div>
        <div class="row">
            <div><label>M√©dia HE (R$)</label><input type="number" id="d13-media" value="0" oninput="calcD13()"></div>
            <div><label>J√° adiantou?</label><input type="number" id="d13-adiant" value="0" placeholder="Valor pago na 1¬™ parc" oninput="calcD13()"></div>
        </div>

        <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-top:10px">
             <div class="fin-row"><span>Base 13¬∫</span><span id="rd-base">R$ 0,00</span></div>
             <div class="fin-row"><span>Valor Proporcional</span><span id="rd-prop">R$ 0,00</span></div>
             <div class="fin-row text-red"><span>- INSS (S√≥ na 2¬™ parc)</span><span id="rd-inss">R$ 0,00</span></div>
             <div class="fin-row text-red"><span>- IRRF</span><span id="rd-irrf">R$ 0,00</span></div>
             <div class="fin-row text-red"><span>- 1¬™ Parc. Paga</span><span id="rd-desc-adiant">R$ 0,00</span></div>
             <div class="fin-row fin-total"><span>A Pagar:</span><span id="rd-liq">R$ 0,00</span></div>
        </div>
    </div>
  </div>

  <div id="view-rescisao" class="view hidden">
    <div class="header"><div class="page-title">Simulador de Rescis√£o</div></div>
    <div class="grid-2">
        <div class="card">
            <h3>Dados do Desligamento</h3>
            <div class="row">
                <div><label>Motivo</label><select id="r-motivo" onchange="calcResc()"><option value="sjc">Sem Justa Causa (Empregador)</option><option value="pedido">Pedido de Demiss√£o</option><option value="acordo">Acordo M√∫tuo</option></select></div>
                <div><label>Data Sa√≠da</label><input type="date" id="r-data" onchange="calcResc()"></div>
            </div>
            <div class="row">
                <div><label>Saldo FGTS</label><input type="number" id="r-fgts" value="0" oninput="calcResc()"></div>
                <div><label>F√©rias Vencidas?</label><select id="r-ferias-venc"><option value="0">N√£o</option><option value="1">Sim</option></select></div>
            </div>
            <button class="btn btn-primary" onclick="calcResc()">Simular</button>
        </div>
        <div class="card" style="background:#fff1f2; border-color:#fda4af">
            <h3>Estimativa de Custos</h3>
            <div class="fin-row"><span>Saldo Sal√°rio</span><span id="rr-saldo">R$ 0,00</span></div>
            <div class="fin-row"><span>Aviso Pr√©vio</span><span id="rr-aviso">R$ 0,00</span></div>
            <div class="fin-row"><span>13¬∫ Proporcional</span><span id="rr-d13">R$ 0,00</span></div>
            <div class="fin-row"><span>F√©rias Prop. + 1/3</span><span id="rr-ferias">R$ 0,00</span></div>
            <div class="fin-row"><span>Multa FGTS (Saque)</span><span id="rr-multa">R$ 0,00</span></div>
            <div class="fin-row text-red"><span>- Impostos (INSS/IR)</span><span id="rr-impostos">R$ 0,00</span></div>
            <div class="fin-row fin-total" style="color:#be123c"><span>Total Rescis√≥rio:</span><span id="rr-total">R$ 0,00</span></div>
            <p style="font-size:11px; margin-top:10px; color:#881337">*A multa de FGTS n√£o √© paga na hora, o empregador apenas libera o saque se j√° recolheu os 3.2% mensais.</p>
        </div>
    </div>
  </div>

  <div id="view-config" class="view hidden">
    <div class="header"><div class="page-title">Configura√ß√µes</div></div>
    <div class="card" style="max-width:500px">
       <label>Nome Funcion√°rio</label><input type="text" id="c-nome" style="margin-bottom:15px">
       <label>Sal√°rio Base (R$)</label><input type="number" id="c-sal" step="0.01" style="margin-bottom:15px">
       <label>Data Admiss√£o</label><input type="date" id="c-adm" style="margin-bottom:15px">
       
       <div style="background:#fffbeb; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #e2e8f0">
         <label>Dia de Vencimento (Guia)</label>
         <select id="c-venc">
           <option value="7">Dia 07 (Padr√£o DAE)</option>
           <option value="20">Dia 20 (GPS/Outros)</option>
         </select>
       </div>
       <button class="btn btn-primary" onclick="saveConfig()">Salvar Configura√ß√µes</button>
    </div>
  </div>

</main>

<script>
// ============================================
// SISTEMA GEST√ÉO DOM√âSTICA - v5.1 (COMPLETA)
// ============================================

let API = localStorage.getItem('gd_v5_url');
let DB = { config: { vencimento: '7' }, horasExtras: [], pagamentos: [], ferias: [] };
const $ = id => document.getElementById(id);
const BRL = v => Number(v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
const NUM = v => parseFloat(v) || 0;

window.onload = () => {
  document.querySelectorAll('input[type="date"]').forEach(i => i.value = new Date().toISOString().split('T')[0]);
  if(API) { $('api-url').value = API; init(); } 
  else { $('loader').classList.add('hidden'); }
}

function nav(view) {
  document.querySelectorAll('.view').forEach(e => e.classList.add('hidden'));
  $( 'view-' + view ).classList.remove('hidden');
  document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
  document.querySelector(`[data-t="${view}"]`).classList.add('active');
}

function connect() {
  const url = $('api-url').value.trim();
  if(!url) return alert('URL inv√°lida');
  localStorage.setItem('gd_v5_url', url);
  API = url;
  init();
}

function logout() {
  localStorage.removeItem('gd_v5_url');
  location.reload();
}

async function init() {
  $('login').classList.add('hidden');
  $('loader').classList.remove('hidden');
  try {
    const res = await fetch(API, {method:'POST', body:JSON.stringify({action:'init'})});
    const json = await res.json();
    if(json.status === 'error') throw new Error(json.message);
    DB = json;
    if(!DB.config.vencimento) DB.config.vencimento = '7';
    render();
    $('loader').classList.add('hidden');
    $('sidebar').classList.remove('hidden');
    $('app').classList.remove('hidden');
    nav('dashboard');
  } catch(e) {
    alert('Erro: ' + e.message);
    $('loader').classList.add('hidden');
    $('login').classList.remove('hidden');
  }
}

// --- C√ÅLCULOS TRIBUT√ÅRIOS ---

function calcINSS(base) {
  let desc = 0, ant = 0;
  const faixas = [{lim:1518, aliq:0.075}, {lim:2793.88, aliq:0.09}, {lim:4190.83, aliq:0.12}, {lim:8157.41, aliq:0.14}];
  for(let f of faixas) {
    if(base > ant) {
      let val = Math.min(base, f.lim) - ant;
      desc += val * f.aliq;
      ant = f.lim;
    }
  }
  return Math.min(desc, 951.63);
}

function calcIRRF(base, inss) {
  const baseIR = base - inss; 
  let ir = 0, deducao = 0;
  if (baseIR <= 2259.20) return 0;
  else if (baseIR <= 2826.65) { ir = baseIR * 0.075; deducao = 169.44; }
  else if (baseIR <= 3751.05) { ir = baseIR * 0.15; deducao = 381.44; }
  else if (baseIR <= 4664.68) { ir = baseIR * 0.225; deducao = 662.77; }
  else { ir = baseIR * 0.275; deducao = 896.00; }
  return Math.max(0, ir - deducao);
}

function calcDAE(bruto, inssFunc, irrfFunc) {
  const fgts = bruto * 0.08;
  const fgtsComp = bruto * 0.032; 
  const inssPatr = bruto * 0.08;
  const gilrat = bruto * 0.008; 
  const totalGuia = fgts + fgtsComp + inssPatr + gilrat + inssFunc + irrfFunc;
  return { fgts, fgtsComp, inssPatr, gilrat, totalGuia };
}

// --- SIMULADORES ESPEC√çFICOS ---

function simula() {
  const sal = NUM(DB.config.salario);
  if(!sal) return {};
  const h50 = NUM($('p-h50').value);
  const h100 = NUM($('p-h100').value);
  const uteis = NUM($('p-uteis').value) || 25;
  const dsr = NUM($('p-dsr').value) || 5;
  const falta = NUM($('p-falta').value);
  const adiant = NUM($('p-adiant').value);

  const vH = sal / 220;
  const tHE = (vH * 1.5 * h50/60) + (vH * 2 * h100/60);
  const tDSR = (tHE / uteis) * dsr;
  const bruto = sal + tHE + tDSR - falta;
  
  const inss = calcINSS(bruto);
  const irrf = calcIRRF(bruto, inss);
  const liq = bruto - inss - irrf - adiant;
  const dae = calcDAE(bruto, inss, irrf);

  $('h-sal').innerText = BRL(sal);
  $('h-he').innerText = BRL(tHE + tDSR);
  $('h-fal').innerText = BRL(falta);
  $('h-base').innerText = BRL(bruto);
  $('h-inss').innerText = `- ${BRL(inss)}`;
  $('h-irrf').innerText = `- ${BRL(irrf)}`;
  $('h-adiant').innerText = `- ${BRL(adiant)}`;
  $('h-liq').innerText = BRL(liq);
  
  return { sal, tHE, tDSR, bruto, inss, irrf, liq, dae, falta, adiant };
}

function simFerias() {
    const sal = NUM(DB.config.salario);
    const dias = NUM($('f-dias').value);
    const media = NUM($('f-media').value);
    const vendeu = $('f-abono').value === 'sim';
    
    // Base F√©rias (Sal + M√©dia)
    const baseTotal = sal + media;
    
    // Valor Dias Gozo
    const diasGozo = vendeu ? dias - 10 : dias;
    const valGozo = (baseTotal / 30) * diasGozo;
    const tercoGozo = valGozo / 3;
    
    // Valor Abono (se vendeu) - Abono N√ÉO tem INSS/IRRF
    let valAbono = 0, tercoAbono = 0;
    if(vendeu) {
        valAbono = (baseTotal / 30) * 10;
        tercoAbono = valAbono / 3;
    }
    
    // Tributa√ß√£o (Apenas sobre Gozo)
    const baseTributavel = valGozo + tercoGozo;
    const inss = calcINSS(baseTributavel);
    const irrf = calcIRRF(baseTributavel, inss);
    
    const liq = (valGozo + tercoGozo + valAbono + tercoAbono) - inss - irrf;

    $('rf-base').innerText = BRL(baseTotal);
    $('rf-ferias').innerText = BRL(valGozo + tercoGozo);
    $('rf-abono').innerText = BRL(valAbono + tercoAbono);
    $('rf-inss').innerText = `- ${BRL(inss)}`;
    $('rf-irrf').innerText = `- ${BRL(irrf)}`;
    $('rf-liq').innerText = BRL(liq);
    
    return { liq, diasGozo };
}

function calcD13() {
    const sal = NUM(DB.config.salario);
    const parc = $('d13-parc').value;
    const meses = NUM($('d13-meses').value);
    const media = NUM($('d13-media').value);
    const adiant = NUM($('d13-adiant').value);
    
    const base = sal + media;
    const prop = (base / 12) * meses;
    
    let inss = 0, irrf = 0, descAdiant = 0, aPagar = 0;
    
    if (parc === '1') {
        aPagar = prop / 2; // Metade sem desconto
    } else {
        inss = calcINSS(prop);
        irrf = calcIRRF(prop, inss);
        descAdiant = adiant; // Desconta o que j√° pagou na 1a
        aPagar = prop - inss - irrf - descAdiant;
    }
    
    $('rd-base').innerText = BRL(base);
    $('rd-prop').innerText = BRL(prop);
    $('rd-inss').innerText = `- ${BRL(inss)}`;
    $('rd-irrf').innerText = `- ${BRL(irrf)}`;
    $('rd-desc-adiant').innerText = `- ${BRL(descAdiant)}`;
    $('rd-liq').innerText = BRL(aPagar);
}

function calcResc() {
    const sal = NUM(DB.config.salario);
    const dataFim = new Date($('r-data').value);
    const admissao = new Date(DB.config.admissao);
    const motivo = $('r-motivo').value;
    const fgts = NUM($('r-fgts').value);
    
    if(!sal || isNaN(dataFim)) return;
    
    const diasTrab = dataFim.getDate();
    const saldoSal = (sal/30) * diasTrab;
    
    let aviso = 0, multa = 0;
    if(motivo === 'sjc') {
        const anos = (dataFim - admissao) / (1000*60*60*24*365);
        aviso = (sal/30) * (30 + (Math.floor(anos)*3));
        multa = fgts * 0.4; // Saque
    } else if(motivo === 'acordo') {
        aviso = (sal/30) * 15;
        multa = fgts * 0.2;
    }
    
    const prop = (sal/12) * (dataFim.getMonth()+1);
    const feriasProp = prop + (prop/3);
    const inss = calcINSS(saldoSal + prop); // Sobre saldo + 13o
    
    $('rr-saldo').innerText = BRL(saldoSal);
    $('rr-aviso').innerText = BRL(aviso);
    $('rr-d13').innerText = BRL(prop);
    $('rr-ferias').innerText = BRL(feriasProp);
    $('rr-multa').innerText = BRL(multa);
    $('rr-impostos').innerText = `- ${BRL(inss)}`;
    $('rr-total').innerText = BRL(saldoSal + aviso + prop + feriasProp - inss);
}

function updateDashboard(pendentes) {
  const sal = NUM(DB.config.salario);
  if(!sal) return;
  
  let min50 = 0, min100 = 0;
  pendentes.forEach(h => {
    if(String(h.tipo).includes('100')) min100 += NUM(h.minutos);
    else min50 += NUM(h.minutos);
  });
  
  const vH = sal / 220;
  const heVal = (vH * 1.5 * min50/60) + (vH * 2 * min100/60);
  const dsrVal = (heVal / 25) * 5; 
  const bruto = sal + heVal + dsrVal;
  const inss = calcINSS(bruto);
  const irrf = calcIRRF(bruto, inss);
  const liq = bruto - inss - irrf;
  const dae = calcDAE(bruto, inss, irrf);

  $('kpi-custo').innerText = BRL(liq + dae.totalGuia);
  $('kpi-dae').innerText = BRL(dae.totalGuia);
  $('kpi-he').innerText = pendentes.length;
  $('kpi-he-val').innerText = `Passivo: ${BRL(heVal)}`;
  
  const diaVenc = DB.config.vencimento || '7';
  $('lbl-vencimento').innerText = `Vence dia ${diaVenc}`;

  $('d-sal').innerText = BRL(sal);
  $('d-he').innerText = BRL(heVal);
  $('d-dsr').innerText = BRL(dsrVal);
  $('d-inss').innerText = `- ${BRL(inss)}`;
  $('d-irrf').innerText = `- ${BRL(irrf)}`;
  $('d-pagar').innerText = BRL(liq);

  $('d-fgts').innerText = BRL(dae.fgts);
  $('d-fgts-comp').innerText = BRL(dae.fgtsComp);
  $('d-patr').innerText = BRL(dae.inssPatr);
  $('d-gilrat').innerText = BRL(dae.gilrat);
  $('d-rep-inss').innerText = `+ ${BRL(inss)}`;
  $('d-total-dae').innerText = BRL(dae.totalGuia);
}

function render() {
  $('c-nome').value = DB.config.nome || '';
  $('c-sal').value = DB.config.salario || '';
  $('c-adm').value = DB.config.admissao || '';
  $('c-venc').value = DB.config.vencimento || '7';
  
  const sal = NUM(DB.config.salario);
  $('ref-hn').innerText = BRL(sal/220);
  $('ref-h50').innerText = BRL((sal/220)*1.5);
  $('ref-h100').innerText = BRL((sal/220)*2);

  const pendentes = DB.horasExtras.filter(h => h.status !== 'Pago');
  updateDashboard(pendentes);
  
  const tbHe = $('tb-he').querySelector('tbody');
  tbHe.innerHTML = '';
  pendentes.reverse().forEach(h => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${h.data}</td><td><span class="badge bg-yellow">${h.tipo}%</span></td><td>${h.minutos}m</td><td>${BRL(h.valorEstimado)}</td><td>${h.status}</td><td><button class="btn btn-sm btn-primary" onclick="markPaid('horasExtras','${h.id}')">Pago</button></td>`;
    tbHe.appendChild(tr);
  });

  const tbPag = $('tb-pag').querySelector('tbody');
  tbPag.innerHTML = '';
  DB.pagamentos.slice().reverse().forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.mes}/${p.ano}</td><td>${BRL(NUM(p.salarioBase)+NUM(p.totalHE)+NUM(p.valorDSR))}</td><td style="color:#ef4444">- ${BRL(NUM(p.valorINSS))}</td><td style="font-weight:bold">${BRL(p.liquido)}</td><td><span class="badge bg-green">Pago</span></td>`;
    tbPag.appendChild(tr);
  });
  
  // Render F√©rias Hist√≥rico
  const tbFer = $('tb-ferias').querySelector('tbody');
  if(DB.ferias && DB.ferias.length > 0) {
      tbFer.innerHTML = '';
      DB.ferias.slice().reverse().forEach(f => {
          tbFer.innerHTML += `<tr><td>${f.inicio}</td><td>${f.dias} dias</td><td>${BRL(f.valorTotal)}</td><td>${f.status}</td></tr>`;
      });
  }

  simula();
}

// --- ACTIONS ---

async function apiCall(action, payload) {
  const btn = event.target;
  const txt = btn.innerText;
  btn.innerText = '...'; btn.disabled = true;
  try {
    const res = await fetch(API, {method:'POST', body:JSON.stringify({action, payload})});
    const j = await res.json();
    if(j.status === 'error') throw new Error(j.message);
    await init();
    alert('Salvo com sucesso!');
  } catch(e) { alert(e.message); } 
  finally { btn.innerText = txt; btn.disabled = false; }
}

function saveConfig() {
  apiCall('updateConfig', {
    nome: $('c-nome').value,
    salario: $('c-sal').value,
    admissao: $('c-adm').value,
    vencimento: $('c-venc').value
  });
}

function saveHE() {
  const min = $('he-min').value;
  const tipo = $('he-tipo').value;
  const sal = NUM(DB.config.salario);
  const val = (sal/220) * (String(tipo).includes('100')?2:1.5) * (min/60);
  apiCall('save', { sheet: 'horasExtras', data: { data: $('he-data').value, tipo, minutos: min, valorEstimado: val, motivo: $('he-motivo').value, status: 'Pendente' } });
}

function saveFolha() {
  const s = simula();
  if(!s.sal) return;
  if(confirm(`Confirmar L√≠quido: ${BRL(s.liq)}?`)) {
    apiCall('save', { sheet: 'pagamentos', data: { mes: $('p-mes').value, ano: $('p-ano').value, salarioBase: s.sal, totalHE: s.tHE, valorDSR: s.tDSR, valorINSS: s.inss, liquido: s.liq, status: 'Pago' } });
  }
}

function saveFerias() {
    const calc = simFerias();
    if(confirm(`Registrar F√©rias? L√≠quido: ${BRL(calc.liq)}`)) {
        apiCall('save', { sheet: 'ferias', data: { inicio: new Date().toISOString().split('T')[0], dias: calc.diasGozo, valorTotal: calc.liq, status: 'Agendado' }});
    }
}

function markPaid(sheet, id) { if(confirm('Confirmar?')) apiCall('markPaid', {sheet, id, status:'Pago'}); }
</script>
</body>
</html>
