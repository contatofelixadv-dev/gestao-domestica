<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gest√£o Dom√©stica (Online)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg: #f8fafc; --surface: #ffffff; --primary: #2563eb; --text: #1e293b; --border: #e2e8f0; --success: #16a34a; --danger: #dc2626; }
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
  body { background: var(--bg); color: var(--text); font-size: 14px; display: flex; height: 100vh; overflow: hidden; }
  
  /* Sidebar */
  aside { width: 240px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
  .brand { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 8px; }
  nav button { width: 100%; text-align: left; padding: 12px; border: none; background: none; color: #64748b; cursor: pointer; border-radius: 6px; font-weight: 500; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
  nav button:hover { background: #f1f5f9; color: var(--text); }
  nav button.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
  
  /* Main */
  main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
  .view { display: none; max-width: 1000px; margin: 0 auto; }
  .view.active { display: block; animation: fadeIn 0.3s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* Components */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .card h3 { font-size: 15px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 16px; letter-spacing: 0.05em; }
  
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
  
  .kpi-box { background: var(--surface); padding: 20px; border-radius: 8px; border: 1px solid var(--border); border-left: 4px solid var(--primary); }
  .kpi-val { font-size: 24px; font-weight: 700; margin: 5px 0; }
  .kpi-lbl { font-size: 12px; color: #64748b; font-weight: 600; }

  /* Forms */
  label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; }
  input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
  input:focus, select:focus { outline: none; border-color: var(--primary); ring: 2px solid #eff6ff; }
  .row { display: flex; gap: 15px; }
  .row > div { flex: 1; }

  /* Buttons */
  .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-outline { background: transparent; border: 1px solid var(--border); }
  
  /* Tables */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 1px solid var(--border); color: #64748b; font-weight: 600; }
  td { padding: 12px; border-bottom: 1px solid var(--border); }
  .status { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
  .status.Pendente { background: #fef3c7; color: #d97706; }
  .status.Pago, .status.ok { background: #dcfce7; color: #15803d; }

  /* Loader & Overlay */
  #overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #connect-screen { max-width: 400px; width: 100%; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid var(--border); text-align: center; display: none; }
  
  /* Utilities */
  .hidden { display: none !important; }
</style>
</head>
<body>

<div id="overlay">
  <div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:15px;color:#64748b;font-weight:500">Sincronizando com a Planilha...</p>
    <p style="font-size:12px;color:#94a3b8">Buscando dados na nuvem</p>
  </div>

  <div id="connect-screen">
    <div style="font-size:40px;margin-bottom:10px">‚òÅÔ∏è</div>
    <h2 style="margin-bottom:10px">Conectar √† Planilha</h2>
    <p style="color:#64748b;margin-bottom:20px;font-size:13px">Cole a URL do Web App do Google Apps Script para iniciar. Seus dados ficam 100% no Google Sheets.</p>
    <input type="text" id="api-url" placeholder="https://script.google.com/macros/s/..." style="font-size:12px">
    <button class="btn btn-primary" style="width:100%" onclick="saveConnection()">Conectar</button>
  </div>
</div>

<aside>
  <div class="brand">üè† Gest√£o Dom√©stica</div>
  <nav>
    <button class="active" onclick="route('dashboard')">üìä Dashboard</button>
    <button onclick="route('pagamentos')">üí∞ Pagamentos</button>
    <button onclick="route('horas')">‚è±Ô∏è Horas Extras</button>
    <button onclick="route('ferias')">üå¥ F√©rias</button>
    <button onclick="route('config')">‚öôÔ∏è Configura√ß√µes</button>
  </nav>
  <div style="margin-top:auto; font-size:11px; color:#94a3b8; text-align:center">
    v2.0 Cloud Only<br>
    <a href="#" onclick="logout()" style="color:var(--danger)">Desconectar</a>
  </div>
</aside>

<main>
  
  <div id="dashboard" class="view active">
    <div class="grid-4">
      <div class="kpi-box">
        <div class="kpi-lbl">FUNCION√ÅRIO</div>
        <div class="kpi-val" style="font-size:18px" id="lbl-nome">...</div>
      </div>
      <div class="kpi-box" style="border-color:#2563eb">
        <div class="kpi-lbl">SAL√ÅRIO BASE</div>
        <div class="kpi-val" id="lbl-salario">R$ ...</div>
      </div>
      <div class="kpi-box" style="border-color:#d97706">
        <div class="kpi-lbl">HE PENDENTES</div>
        <div class="kpi-val" style="color:#d97706" id="lbl-he-pend">...</div>
      </div>
    </div>
    <div class="card">
      <h3>√öltimos Pagamentos</h3>
      <table id="tb-last-pag">
        <thead><tr><th>M√™s/Ano</th><th>Total Pago</th><th>Status</th></tr></thead>
        <tbody><tr><td colspan="3" align="center">Carregando...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div id="pagamentos" class="view">
    <div class="grid-2">
      <div class="card">
        <h3>Novo Pagamento</h3>
        <div class="row">
          <div><label>M√™s</label><select id="pag-mes"><option value="1">Jan</option><option value="2">Fev</option><option value="3">Mar</option><option value="4">Abr</option><option value="5">Mai</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Ago</option><option value="9">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select></div>
          <div><label>Ano</label><input type="number" id="pag-ano" value="2026"></div>
        </div>
        <div class="row">
          <div><label>H.E. 50% (min)</label><input type="number" id="pag-h50" value="0" oninput="simulaPag()"></div>
          <div><label>H.E. 100% (min)</label><input type="number" id="pag-h100" value="0" oninput="simulaPag()"></div>
        </div>
        <div class="row">
          <div><label>Dias √öteis (DSR)</label><input type="number" id="pag-uteis" value="25" oninput="simulaPag()"></div>
          <div><label>Domingos/Fer</label><input type="number" id="pag-dsr-dias" value="5" oninput="simulaPag()"></div>
        </div>
        <div class="row">
          <div><label>Faltas (R$)</label><input type="number" id="pag-faltas" value="0" oninput="simulaPag()"></div>
          <div><label>Adiantamento (R$)</label><input type="number" id="pag-adiant" value="0" oninput="simulaPag()"></div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="savePagamento()">Lan√ßar Pagamento</button>
      </div>

      <div class="card" style="background:#f8fafc">
        <h3>Pr√©via do C√°lculo</h3>
        <div id="pag-preview" style="display:flex; flex-direction:column; gap:8px; font-size:14px">
          </div>
      </div>
    </div>
    
    <div class="card">
      <h3>Hist√≥rico Completo</h3>
      <table id="tb-pag"><thead><tr><th>Data</th><th>Sal√°rio</th><th>H.Extras + DSR</th><th>L√≠quido</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="horas" class="view">
    <div class="card">
      <h3>Registrar Hora Extra</h3>
      <div class="row">
        <div><label>Data</label><input type="date" id="he-data"></div>
        <div><label>Minutos</label><input type="number" id="he-min" placeholder="Ex: 60"></div>
        <div><label>Tipo</label><select id="he-tipo"><option value="50%">50% (Dia √ötil)</option><option value="100%">100% (Dom/Fer)</option></select></div>
      </div>
      <input type="text" id="he-motivo" placeholder="Motivo (Opcional)">
      <button class="btn btn-primary" onclick="saveHE()" style="margin-top:10px">Salvar</button>
    </div>
    <div class="card">
      <h3>Banco de Horas</h3>
      <table id="tb-he"><thead><tr><th>Data</th><th>Tipo</th><th>Min</th><th>Motivo</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="config" class="view">
    <div class="card" style="border-left:4px solid #8b5cf6">
      <h3>Dados do Contrato (Salvos na Nuvem)</h3>
      <p style="font-size:12px; color:#64748b; margin-bottom:15px">Esses dados s√£o compartilhados com quem acessar a planilha.</p>
      
      <label>Nome do Funcion√°rio</label>
      <input type="text" id="cfg-nome">
      
      <label>Sal√°rio Base (R$)</label>
      <input type="number" id="cfg-salario" step="0.01">
      
      <label>Data de Admiss√£o</label>
      <input type="date" id="cfg-admissao">
      
      <button class="btn btn-primary" onclick="saveCloudConfig()">Salvar na Nuvem</button>
    </div>
    
    <div class="card">
      <h3>Conex√£o</h3>
      <label>URL do Script (Local apenas)</label>
      <input type="text" id="cfg-url" readonly style="background:#f1f5f9; color:#94a3b8">
      <p style="font-size:11px; color:#94a3b8">Para acessar de outro PC, use este mesmo link.</p>
    </div>
  </div>

</main>

<script>
// ============================================
// L√ìGICA DO CLIENTE (SEM CACHE DE DADOS)
// ============================================

let API_URL = localStorage.getItem('gestao_api_url');
let GLOBAL_DATA = null; // Dados tempor√°rios apenas enquanto a p√°gina est√° aberta

const $ = id => document.getElementById(id);
const BRL = v => Number(v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

// INICIALIZA√á√ÉO
window.onload = () => {
  // Ajusta data inputs para hoje
  const today = new Date().toISOString().split('T')[0];
  if($('he-data')) $('he-data').value = today;

  if (!API_URL) {
    $('loader').classList.add('hidden');
    $('connect-screen').style.display = 'block';
  } else {
    $('cfg-url').value = API_URL;
    fetchData();
  }
};

// SALVAR CONEXAO
function saveConnection() {
  const url = $('api-url').value.trim();
  if (!url) return alert('Cole a URL!');
  localStorage.setItem('gestao_api_url', url);
  API_URL = url;
  location.reload();
}

function logout() {
  if(confirm('Isso vai desconectar este computador. O link da planilha ser√° esquecido.')) {
    localStorage.removeItem('gestao_api_url');
    location.reload();
  }
}

// BUSCAR DADOS (INIT)
async function fetchData() {
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'init' })
    });
    const data = await res.json();
    
    if (data.status === 'error') throw new Error(data.message);
    
    GLOBAL_DATA = data;
    renderAll();
    $('overlay').classList.add('hidden'); // Some o loader
    
  } catch (err) {
    alert('Erro ao conectar: ' + err.message);
    $('loader').innerHTML = `<p style="color:red">Erro de conex√£o</p><button class="btn btn-outline" onclick="logout()">Trocar URL</button>`;
  }
}

// RENDERIZA√á√ÉO
function renderAll() {
  const cfg = GLOBAL_DATA.config || {};
  
  // Preencher Configs
  $('cfg-nome').value = cfg.nome || '';
  $('cfg-salario').value = cfg.salario || '';
  $('cfg-admissao').value = cfg.admissao || '';

  // Labels Dashboard
  $('lbl-nome').innerText = cfg.nome || 'N√£o configurado';
  $('lbl-salario').innerText = BRL(cfg.salario);
  
  // HE Pendentes
  const he = GLOBAL_DATA.horasExtras || [];
  const pendentes = he.filter(h => h.status !== 'Pago').length;
  $('lbl-he-pend').innerText = pendentes > 0 ? `${pendentes} registros` : 'Nenhuma';

  // Tabela Pagamentos
  const pags = (GLOBAL_DATA.pagamentos || []).reverse();
  renderTable('tb-pag', pags, row => `
    <td>${row.mes}/${row.ano}</td>
    <td>${BRL(row.salarioBase)}</td>
    <td>${BRL(Number(row.hExtrasTotal||0) + Number(row.dsrValor||0))}</td>
    <td style="font-weight:bold">${BRL(row.total)}</td>
    <td><span class="status ${row.status}">${row.status}</span></td>
  `);

  // Tabela √öltimos (Dash)
  renderTable('tb-last-pag', pags.slice(0, 3), row => `
    <td>${row.mes}/${row.ano}</td>
    <td>${BRL(row.total)}</td>
    <td><span class="status ${row.status}">${row.status}</span></td>
  `);

  // Tabela HE
  renderTable('tb-he', (GLOBAL_DATA.horasExtras || []).reverse(), row => `
    <td>${new Date(row.data).toLocaleDateString()}</td>
    <td>${row.tipo}</td>
    <td>${row.minutos}m</td>
    <td>${row.motivo}</td>
    <td><span class="status ${row.status}">${row.status}</span></td>
  `);
  
  simulaPag(); // Atualiza preview
}

function renderTable(id, data, fn) {
  const tbody = $(id).querySelector('tbody');
  tbody.innerHTML = '';
  if (!data.length) tbody.innerHTML = '<tr><td colspan="5" align="center" style="color:#94a3b8">Sem registros</td></tr>';
  data.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = fn(d);
    tbody.appendChild(tr);
  });
}

// SIMULADOR PAGAMENTO
function simulaPag() {
  const sal = Number($('cfg-salario').value) || 0;
  const h50 = Number($('pag-h50').value) || 0;
  const h100 = Number($('pag-h100').value) || 0;
  const diasUteis = Number($('pag-uteis').value) || 25;
  const diasDsr = Number($('pag-dsr-dias').value) || 5;
  const faltasVal = Number($('pag-faltas').value) || 0;
  const adiant = Number($('pag-adiant').value) || 0;

  // Calculos
  const vHora = sal / 220; // Divisor padrao
  const vHe50 = vHora * 1.5 * (h50/60);
  const vHe100 = vHora * 2.0 * (h100/60);
  const totalHe = vHe50 + vHe100;
  
  const dsr = (totalHe / diasUteis) * diasDsr;
  
  const bruto = sal + totalHe + dsr - faltasVal;
  
  // INSS 2025 aprox progressivo
  let inss = 0;
  let baseResto = bruto;
  const faixas = [{lim:1518, aliq:0.075}, {lim:2793, aliq:0.09}, {lim:4190, aliq:0.12}, {lim:8157, aliq:0.14}];
  let anterior = 0;
  for(let f of faixas) {
    if(bruto > anterior) {
      let baseFaixa = Math.min(bruto, f.lim) - anterior;
      inss += baseFaixa * f.aliq;
      anterior = f.lim;
    }
  }
  if (inss > 951.63) inss = 951.63; // Teto

  const liquido = bruto - inss - adiant;

  $('pag-preview').innerHTML = `
    <div style="display:flex;justify-content:space-between"><span>Sal√°rio</span><span>${BRL(sal)}</span></div>
    <div style="display:flex;justify-content:space-between"><span>H.Extras</span><span>${BRL(totalHe)}</span></div>
    <div style="display:flex;justify-content:space-between"><span>Reflexo DSR</span><span>${BRL(dsr)}</span></div>
    <div style="display:flex;justify-content:space-between;color:red"><span>Faltas</span><span>- ${BRL(faltasVal)}</span></div>
    <div style="border-top:1px dashed #ccc; margin:5px 0"></div>
    <div style="display:flex;justify-content:space-between;font-weight:bold"><span>Bruto</span><span>${BRL(bruto)}</span></div>
    <div style="display:flex;justify-content:space-between;color:red"><span>INSS</span><span>- ${BRL(inss)}</span></div>
    <div style="display:flex;justify-content:space-between;color:red"><span>Adiantamento</span><span>- ${BRL(adiant)}</span></div>
    <div style="background:#dcfce7; color:#166534; padding:8px; border-radius:4px; font-weight:bold; text-align:center; margin-top:5px">
      L√≠quido: ${BRL(liquido)}
    </div>
  `;
  
  return { sal, totalHe, dsr, faltasVal, inss, adiant, liquido };
}

// A√á√ïES (POST)
async function sendData(action, payload) {
  $('overlay').classList.remove('hidden');
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action, payload })
    });
    const json = await res.json();
    if(json.status === 'error') throw new Error(json.message);
    
    await fetchData(); // Recarrega tudo atualizado da nuvem
    alert('Salvo com sucesso!');
  } catch(e) {
    alert('Erro: ' + e.message);
    $('overlay').classList.add('hidden');
  }
}

function savePagamento() {
  const calc = simulaPag();
  const payload = {
    sheet: 'pagamentos',
    data: {
      mes: $('pag-mes').value,
      ano: $('pag-ano').value,
      salarioBase: calc.sal,
      hExtrasTotal: calc.totalHe,
      dsrValor: calc.dsr,
      faltas: calc.faltasVal,
      inss: calc.inss,
      adiantamento: calc.adiant,
      total: calc.liquido,
      status: 'Pago'
    }
  };
  if(confirm(`Confirmar pagamento de ${BRL(calc.liquido)}?`)) {
    sendData('save', payload);
  }
}

function saveHE() {
  const payload = {
    sheet: 'horasExtras',
    data: {
      data: $('he-data').value,
      tipo: $('he-tipo').value,
      minutos: $('he-min').value,
      motivo: $('he-motivo').value,
      status: 'Pendente'
    }
  };
  if(!payload.data.minutos) return alert('Informe os minutos');
  sendData('save', payload);
}

function saveCloudConfig() {
  const payload = {
    nome: $('cfg-nome').value,
    salario: $('cfg-salario').value,
    admissao: $('cfg-admissao').value
  };
  if(!payload.salario) return alert('Informe o sal√°rio');
  sendData('saveConfig', payload);
}

// Roteamento Simples
function route(viewId) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
  
  $(viewId).classList.add('active');
  // Hack para achar o bot√£o e marcar active
  const btn = Array.from(document.querySelectorAll('nav button')).find(b => b.innerText.toLowerCase().includes(viewId.substring(0,3)));
  if(btn) btn.classList.add('active');
}
</script>
</body>
</html>
