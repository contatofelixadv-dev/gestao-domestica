<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gest√£o Dom√©stica Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f3f4f6; --surface: #ffffff;
    --primary: #3b82f6; --primary-dark: #2563eb;
    --text: #1f2937; --text-light: #6b7280;
    --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
    --border: #e5e7eb;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; font-size: 14px; }

  /* SIDEBAR */
  aside { width: 260px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
  .logo { padding: 24px; font-size: 20px; font-weight: 800; color: var(--primary-dark); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
  nav { flex: 1; padding: 16px; overflow-y: auto; }
  .nav-item { display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px 16px; color: var(--text-light); background: transparent; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; margin-bottom: 4px; transition: all 0.2s; text-align: left; }
  .nav-item:hover { background: #eff6ff; color: var(--primary); }
  .nav-item.active { background: #dbeafe; color: var(--primary-dark); font-weight: 600; }
  .nav-icon { width: 20px; text-align: center; font-size: 16px; }

  /* MAIN */
  main { flex: 1; overflow-y: auto; padding: 32px; position: relative; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
  .title h1 { font-size: 24px; font-weight: 700; color: var(--text); }
  .title p { color: var(--text-light); margin-top: 4px; }

  /* CARDS & GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 24px; }
  .card { background: var(--surface); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 24px; }
  .card h3 { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  
  /* METRICS */
  .metric { padding: 20px; border-radius: 12px; background: var(--surface); border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden; }
  .metric-label { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-light); margin-bottom: 8px; }
  .metric-value { font-size: 28px; font-weight: 700; color: var(--text); }
  .metric-sub { font-size: 12px; margin-top: 4px; color: var(--text-light); }
  .metric-highlight { color: var(--primary-dark); }
  
  /* FORMS & TABLES */
  .form-group { margin-bottom: 16px; }
  .form-row { display: flex; gap: 16px; margin-bottom: 16px; }
  .form-row > div { flex: 1; }
  label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text); }
  input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; transition: border 0.2s; }
  input:focus, select:focus { border-color: var(--primary); ring: 2px solid #dbeafe; }
  
  .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; gap: 8px; }
  .btn-primary { background: var(--primary-dark); color: white; }
  .btn-primary:hover { background: var(--primary); }
  .btn-danger { background: #fee2e2; color: var(--danger); }
  .btn-sm { padding: 6px 12px; font-size: 12px; }

  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th { text-align: left; padding: 12px 16px; background: #f9fafb; color: var(--text-light); font-weight: 600; font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
  td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: var(--text); }
  tr:last-child td { border-bottom: none; }
  
  .badge { display: inline-block; padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .badge-pendente { background: #fef3c7; color: #b45309; }
  .badge-pago, .badge-ok { background: #d1fae5; color: #047857; }
  .badge-aviso { background: #fee2e2; color: #b91c1c; }

  /* CALC BOX (Preview) */
  .calc-box { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .calc-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
  .calc-line.total { border-top: 2px solid var(--border); margin-top: 12px; padding-top: 12px; font-weight: 700; font-size: 16px; color: var(--primary-dark); }
  .text-danger { color: var(--danger); }

  /* LOADER */
  #overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .hidden { display: none !important; }
  
  /* LOGIN SCREEN */
  #login-screen { max-width: 400px; width: 100%; padding: 40px; background: white; border-radius: 16px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border); }
</style>
</head>
<body>

<div id="overlay">
  <div id="loader" class="hidden" style="text-align:center">
    <div class="spinner" style="margin:0 auto 16px"></div>
    <h3 style="color:var(--text)">Sincronizando...</h3>
    <p style="color:var(--text-light)">Buscando dados no Google Sheets</p>
  </div>

  <div id="login-screen">
    <div style="font-size:48px; margin-bottom:16px">‚òÅÔ∏è</div>
    <h2 style="margin-bottom:8px">Conectar Sistema</h2>
    <p style="color:var(--text-light); margin-bottom:24px; font-size:13px">Cole a URL do Web App do Google Apps Script para acessar os dados.</p>
    <div class="form-group">
      <input type="text" id="api-url" placeholder="https://script.google.com/macros/s/..." style="text-align:center">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="connectAPI()">Acessar Painel</button>
  </div>
</div>

<aside id="app-sidebar" class="hidden">
  <div class="logo">üè† Gest√£o Dom√©stica</div>
  <nav>
    <button class="nav-item active" onclick="nav('dashboard')" data-target="dashboard"><span class="nav-icon">üìä</span>Dashboard</button>
    <button class="nav-item" onclick="nav('pagamentos')" data-target="pagamentos"><span class="nav-icon">üí∞</span>Pagamentos</button>
    <button class="nav-item" onclick="nav('horas')" data-target="horas"><span class="nav-icon">‚è±Ô∏è</span>Banco de Horas</button>
    <button class="nav-item" onclick="nav('ferias')" data-target="ferias"><span class="nav-icon">üå¥</span>F√©rias</button>
    <button class="nav-item" onclick="nav('rescisao')" data-target="rescisao"><span class="nav-icon">‚ö†Ô∏è</span>Rescis√£o</button>
    <button class="nav-item" onclick="nav('config')" data-target="config"><span class="nav-icon">‚öôÔ∏è</span>Configura√ß√µes</button>
  </nav>
  <div style="padding:20px; margin-top:auto">
    <div style="font-size:11px; color:var(--text-light); text-align:center">
      Status: <span style="color:var(--success)">‚óè Online</span><br>
      <a href="#" onclick="logout()" style="color:var(--danger); text-decoration:none">Desconectar</a>
    </div>
  </div>
</aside>

<main id="app-main" class="hidden">

  <div id="view-dashboard" class="view">
    <div class="header">
      <div class="title">
        <h1>Vis√£o Geral</h1>
        <p>Resumo em tempo real</p>
      </div>
      <button class="btn btn-sm btn-primary" onclick="initData()">üîÑ Atualizar Dados</button>
    </div>

    <div class="grid-3">
      <div class="metric" style="border-left: 4px solid var(--primary-dark)">
        <div class="metric-label">Previs√£o L√≠quida (Este M√™s)</div>
        <div class="metric-value metric-highlight" id="dash-prev-liq">R$ 0,00</div>
        <div class="metric-sub">Sal√°rio + HE Pendentes - INSS</div>
      </div>

      <div class="metric">
        <div class="metric-label">H.E. Pendentes (M√™s)</div>
        <div class="metric-value" style="color:var(--warning)" id="dash-he-count">0</div>
        <div class="metric-sub text-danger" id="dash-he-val">Valor: R$ 0,00</div>
      </div>

      <div class="metric">
        <div class="metric-label">Pr√≥ximo DAE</div>
        <div class="metric-value" style="color:var(--success)" id="dash-dae">Dia 07</div>
        <div class="metric-sub">Vencimento</div>
      </div>
    </div>

    <div class="card">
      <h3>Detalhamento da Previs√£o Atual</h3>
      <div id="dash-prev-details" style="font-size:13px; color:var(--text-light)">
        Carregando...
      </div>
    </div>

    <div class="card">
      <h3>Alertas do Sistema</h3>
      <div id="dash-alerts">
        <p style="color:var(--text-light)">Nenhum alerta pendente.</p>
      </div>
    </div>
  </div>

  <div id="view-pagamentos" class="view hidden">
    <div class="header">
      <div class="title"><h1>Folha de Pagamento</h1><p>Hist√≥rico e Fechamento de M√™s</p></div>
    </div>

    <div class="grid-2">
      <div class="card">
        <h3>Lan√ßar Pagamento (Fechamento)</h3>
        <div class="form-row">
          <div><label>M√™s</label><select id="pag-mes"><option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Mar√ßo</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option></select></div>
          <div><label>Ano</label><input type="number" id="pag-ano" value="2026"></div>
        </div>
        
        <div class="form-row">
          <div><label>Dias √öteis</label><input type="number" id="pag-uteis" value="25" oninput="simulaPag()"></div>
          <div><label>Domingos/Fer.</label><input type="number" id="pag-dsr" value="5" oninput="simulaPag()"></div>
        </div>

        <div class="form-row">
          <div><label>H.E. 50% (min)</label><input type="number" id="pag-he50" value="0" oninput="simulaPag()"></div>
          <div><label>H.E. 100% (min)</label><input type="number" id="pag-he100" value="0" oninput="simulaPag()"></div>
        </div>

        <div class="form-row">
          <div><label>Faltas (R$)</label><input type="number" id="pag-faltas" value="0" step="0.01" oninput="simulaPag()"></div>
          <div><label>Adiantamento (R$)</label><input type="number" id="pag-adiant" value="0" step="0.01" oninput="simulaPag()"></div>
        </div>

        <button class="btn btn-primary" style="width:100%" onclick="savePagamento()">üíæ Salvar Folha</button>
      </div>

      <div class="calc-box">
        <h3>Demonstrativo (Pr√©via)</h3>
        <div class="calc-line"><span>Sal√°rio Base</span><span id="c-sal">R$ 0,00</span></div>
        <div class="calc-line"><span>(+) Total H.Extras</span><span id="c-he">R$ 0,00</span></div>
        <div class="calc-line"><span>(+) Reflexo DSR s/ HE</span><span id="c-dsr">R$ 0,00</span></div>
        <div class="calc-line text-danger"><span>(-) Faltas</span><span id="c-fal">- R$ 0,00</span></div>
        <div style="border-bottom:1px dashed #ccc; margin:8px 0;"></div>
        <div class="calc-line" style="font-weight:600"><span>= Base INSS/FGTS</span><span id="c-base">R$ 0,00</span></div>
        <div class="calc-line text-danger"><span>(-) INSS (Progressivo)</span><span id="c-inss">- R$ 0,00</span></div>
        <div class="calc-line text-danger"><span>(-) Adiantamento</span><span id="c-adiant">- R$ 0,00</span></div>
        <div class="calc-line total"><span>L√≠quido a Pagar</span><span id="c-liq">R$ 0,00</span></div>
      </div>
    </div>

    <div class="card">
      <h3>Hist√≥rico</h3>
      <table id="tb-pag"><thead><tr><th>Data</th><th>Sal√°rio Base</th><th>H.E. + DSR</th><th>INSS</th><th>L√≠quido</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-horas" class="view hidden">
    <div class="header">
      <div class="title"><h1>Banco de Horas</h1><p>Registro de horas suplementares</p></div>
    </div>
    
    <div class="grid-2">
        <div class="card">
            <h3>Nova Hora Extra</h3>
            <div class="form-row">
                <div><label>Data</label><input type="date" id="he-data"></div>
                <div><label>Minutos</label><input type="number" id="he-min" placeholder="Ex: 60"></div>
            </div>
            <div class="form-row">
                <div>
                    <label>Tipo</label>
                    <select id="he-tipo">
                        <option value="50">50% (Dia √∫til)</option>
                        <option value="100">100% (Dom/Feriado)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Motivo</label>
                <input type="text" id="he-motivo" placeholder="Ex: Jantar atrasou">
            </div>
            <button class="btn btn-primary" onclick="saveHE()">Registrar</button>
        </div>
        <div class="metric" style="height:fit-content">
            <div class="metric-label">Valor da Hora (Estimativa)</div>
            <div style="font-size:14px; margin-bottom:10px">Baseado no sal√°rio atual</div>
            <div class="calc-line"><span>Hora Normal:</span><span id="v-h-norm">R$ 0,00</span></div>
            <div class="calc-line"><span>Hora 50%:</span><span id="v-h-50">R$ 0,00</span></div>
            <div class="calc-line"><span>Hora 100%:</span><span id="v-h-100">R$ 0,00</span></div>
            <div style="margin-top:10px; font-size:12px; color:var(--text-light)">*N√£o inclui DSR neste c√°lculo r√°pido.</div>
        </div>
    </div>

    <div class="card">
      <h3>Hist√≥rico</h3>
      <table id="tb-he"><thead><tr><th>Data</th><th>Tipo</th><th>Tempo</th><th>Valor Est.*</th><th>Motivo</th><th>Status</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-ferias" class="view hidden">
    <div class="header"><div class="title"><h1>Controle de F√©rias</h1></div></div>
    <div class="card">
        <h3>Hist√≥rico</h3>
        <table id="tb-ferias"><thead><tr><th>In√≠cio</th><th>Dias</th><th>Status</th></tr></thead><tbody><tr><td colspan="3">Sem registros.</td></tr></tbody></table>
    </div>
  </div>

  <div id="view-rescisao" class="view hidden">
    <div class="header">
        <div class="title"><h1>Simulador de Rescis√£o</h1><p>Estimativa de custos para desligamento</p></div>
    </div>
    
    <div class="grid-2">
        <div class="card">
            <h3>Dados do Desligamento</h3>
            <div class="form-row">
                <div><label>Motivo</label><select id="resc-motivo" onchange="calcRescisao()"><option value="sjc">Sem Justa Causa (Empregador)</option><option value="pedido">Pedido de Demiss√£o</option><option value="acordo">Acordo M√∫tuo</option></select></div>
                <div><label>Data Sa√≠da</label><input type="date" id="resc-data" onchange="calcRescisao()"></div>
            </div>
            <div class="form-row">
                <div><label>Saldo FGTS (App)</label><input type="number" id="resc-fgts" value="0" oninput="calcRescisao()"></div>
                <div><label>F√©rias Vencidas?</label><select id="resc-ferias-venc"><option value="0">N√£o</option><option value="1">Sim (1 per√≠odo)</option></select></div>
            </div>
            <button class="btn btn-primary" onclick="calcRescisao()">Calcular Estimativa</button>
        </div>

        <div class="calc-box">
            <h3>C√°lculo Estimado</h3>
            <div class="calc-line"><span>Saldo Sal√°rio</span><span id="r-saldo">R$ 0,00</span></div>
            <div class="calc-line"><span>Aviso Pr√©vio (Indenizado)</span><span id="r-aviso">R$ 0,00</span></div>
            <div class="calc-line"><span>13¬∫ Proporcional</span><span id="r-d13">R$ 0,00</span></div>
            <div class="calc-line"><span>F√©rias Prop. + 1/3</span><span id="r-ferias">R$ 0,00</span></div>
            <div class="calc-line"><span>Multa FGTS</span><span id="r-multa">R$ 0,00</span></div>
            <div class="calc-line text-danger"><span>(-) INSS Rescis√£o</span><span id="r-inss">- R$ 0,00</span></div>
            <div class="calc-line total"><span>Total Rescis√≥rio</span><span id="r-total">R$ 0,00</span></div>
        </div>
    </div>
  </div>

  <div id="view-config" class="view hidden">
    <div class="header"><div class="title"><h1>Configura√ß√µes</h1></div></div>
    <div class="card" style="max-width:600px">
        <h3>Dados Contratuais (Nuvem)</h3>
        <div class="form-group"><label>Nome Funcion√°rio</label><input type="text" id="cfg-nome"></div>
        <div class="form-group"><label>Sal√°rio Base</label><input type="number" id="cfg-salario" step="0.01"></div>
        <div class="form-group"><label>Data Admiss√£o</label><input type="date" id="cfg-admissao"></div>
        <button class="btn btn-primary" onclick="saveConfig()">Salvar Altera√ß√µes</button>
    </div>
  </div>

</main>

<script>
// ==========================================
// L√ìGICA DO SISTEMA
// ==========================================

let API_URL = localStorage.getItem('gd_api_url');
let DB = { config: {}, horasExtras: [], pagamentos: [] };

const $ = id => document.getElementById(id);
const BRL = v => Number(v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
const NUM = v => parseFloat(v) || 0;
const ISO = d => d ? new Date(d).toISOString().split('T')[0] : '';

// --- INICIALIZA√á√ÉO E NAVEGA√á√ÉO ---

window.onload = () => {
  // Ajustar inputs de data para hoje
  document.querySelectorAll('input[type="date"]').forEach(i => i.value = new Date().toISOString().split('T')[0]);
  
  if(API_URL) {
    $('api-url').value = API_URL;
    initData();
  } else {
    $('loader').classList.add('hidden');
  }
};

function nav(viewId) {
    // 1. Esconde todas as views
    document.querySelectorAll('.view').forEach(e => e.classList.add('hidden'));
    
    // 2. Mostra a view desejada
    const target = $('view-' + viewId);
    if(target) target.classList.remove('hidden');

    // 3. Atualiza Sidebar (Corre√ß√£o do erro "currentTarget")
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    
    // Procura o bot√£o que tem o atributo data-target igual √† viewId
    const activeBtn = document.querySelector(`.nav-item[data-target="${viewId}"]`);
    if(activeBtn) activeBtn.classList.add('active');
}

function connectAPI() {
    const url = $('api-url').value.trim();
    if(!url) return alert('Digite a URL');
    localStorage.setItem('gd_api_url', url);
    API_URL = url;
    initData();
}

function logout() {
    localStorage.removeItem('gd_api_url');
    location.reload();
}

async function initData() {
    if(!API_URL) return;
    
    $('login-screen').classList.add('hidden');
    $('loader').classList.remove('hidden');
    
    try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'init' }) });
        const json = await res.json();
        if(json.status === 'error') throw new Error(json.message);

        DB = json;
        renderAll();
        
        $('overlay').classList.add('hidden');
        $('app-sidebar').classList.remove('hidden');
        $('app-main').classList.remove('hidden');
        nav('dashboard'); // Navega para dashboard com a fun√ß√£o corrigida
        
    } catch(e) {
        alert('Erro: ' + e.message);
        $('loader').classList.add('hidden');
        $('login-screen').classList.remove('hidden');
    }
}

// --- RENDERIZA√á√ÉO ---

function renderAll() {
    // Configs
    $('cfg-nome').value = DB.config.nome || '';
    $('cfg-salario').value = DB.config.salario || '';
    $('cfg-admissao').value = DB.config.admissao || '';

    // Tabelas
    renderTable('tb-pag', DB.pagamentos.reverse(), r => `
        <td>${r.mes}/${r.ano}</td>
        <td>${BRL(r.salarioBase)}</td>
        <td>${BRL(NUM(r.totalHE)+NUM(r.valorDSR))}</td>
        <td>${BRL(r.valorINSS)}</td>
        <td style="font-weight:bold">${BRL(r.liquido)}</td>
        <td><span class="badge badge-ok">Pago</span></td>
    `);

    renderTable('tb-he', DB.horasExtras.reverse(), r => {
        const val = r.valorEstimado || calcHEValue(r.minutos, r.tipo);
        return `
        <td>${ISO(r.data)}</td>
        <td>${r.tipo}%</td>
        <td>${r.minutos}m</td>
        <td>${BRL(val)}</td>
        <td>${r.motivo}</td>
        <td><span class="badge badge-${r.status==='Pago'?'pago':'pendente'}">${r.status}</span></td>
        <td>${r.status!=='Pago' ? `<button class="btn-sm" onclick="markPaid('horasExtras','${r.id}')">‚úî</button>` : '-'}</td>
    `});

    updateDashboard(); // Nova l√≥gica de previs√£o
    simulaPag();       // Atualiza simulador da aba pagamentos
}

function updateDashboard() {
    const sal = NUM(DB.config.salario);
    
    // 1. Filtrar HE Pendentes do M√™s Atual
    const now = new Date();
    const mesAtual = now.getMonth(); // 0-11
    const anoAtual = now.getFullYear();
    
    const pendentes = DB.horasExtras.filter(h => h.status !== 'Pago');
    
    let totalMin50 = 0;
    let totalMin100 = 0;
    let countMes = 0;

    pendentes.forEach(h => {
        const d = new Date(h.data);
        // Conta HE se for do m√™s atual (para previs√£o de pgto) OU se for pendente antiga
        if (d.getMonth() === mesAtual && d.getFullYear() === anoAtual) {
            if(h.tipo == '50' || h.tipo == '50%') totalMin50 += NUM(h.minutos);
            else totalMin100 += NUM(h.minutos);
            countMes++;
        }
    });

    // 2. Calcular Valores
    const vHora = sal / 220;
    const v50 = vHora * 1.5 * (totalMin50/60);
    const v100 = vHora * 2 * (totalMin100/60);
    const totalHE = v50 + v100;
    
    // DSR Estimado (25 dias √∫teis / 5 descansos - padr√£o)
    const dsrEst = (totalHE / 25) * 5;
    
    const bruto = sal + totalHE + dsrEst;
    const inss = calcINSS(bruto);
    const liquidoPrevisto = bruto - inss;

    // 3. Atualizar UI
    $('dash-prev-liq').innerText = BRL(liquidoPrevisto);
    $('dash-he-count').innerText = countMes;
    $('dash-he-val').innerText = `Total HE: ${BRL(totalHE)}`;
    
    $('dash-prev-details').innerHTML = `
        Sal√°rio: ${BRL(sal)} <br>
        + HE (${Math.round((totalMin50+totalMin100)/60)}h): ${BRL(totalHE)} <br>
        + DSR (Est.): ${BRL(dsrEst)} <br>
        - INSS: ${BRL(inss)}
    `;

    // Atualiza refer√™ncia valores hora
    $('v-h-norm').innerText = BRL(vHora);
    $('v-h-50').innerText = BRL(vHora * 1.5);
    $('v-h-100').innerText = BRL(vHora * 2);
}

function renderTable(id, data, fn) {
    const tbody = $(id).querySelector('tbody');
    tbody.innerHTML = '';
    if(!data.length) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">Sem dados</td></tr>';
    data.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = fn(d);
        tbody.appendChild(tr);
    });
}

// --- C√ÅLCULOS MATEM√ÅTICOS ---

function calcHEValue(min, tipo) {
    const sal = NUM(DB.config.salario);
    const fator = (tipo == '100' || tipo == '100%') ? 2 : 1.5;
    return (sal / 220) * fator * (min / 60);
}

function calcINSS(base) {
    let desc = 0;
    let anterior = 0;
    const faixas = [
        {lim: 1518.00, aliq: 0.075},
        {lim: 2793.88, aliq: 0.09},
        {lim: 4190.83, aliq: 0.12},
        {lim: 8157.41, aliq: 0.14}
    ];
    for(let f of faixas) {
        if(base > anterior) {
            let baseFaixa = Math.min(base, f.lim) - anterior;
            desc += baseFaixa * f.aliq;
            anterior = f.lim;
        }
    }
    return Math.min(desc, 951.63); // Teto 2025
}

function simulaPag() {
    const sal = NUM(DB.config.salario);
    if(!sal) return;
    
    const h50 = NUM($('pag-he50').value);
    const h100 = NUM($('pag-he100').value);
    const uteis = NUM($('pag-uteis').value) || 25;
    const dsrDias = NUM($('pag-dsr').value) || 5;
    const faltas = NUM($('pag-faltas').value);
    const adiant = NUM($('pag-adiant').value);

    const vHora = sal / 220;
    const v50 = vHora * 1.5 * (h50/60);
    const v100 = vHora * 2 * (h100/60);
    const totalHE = v50 + v100;

    const valDSR = (totalHE / uteis) * dsrDias;
    const bruto = sal + totalHE + valDSR - faltas;
    const inss = calcINSS(bruto);
    const liq = bruto - inss - adiant;

    $('c-sal').innerText = BRL(sal);
    $('c-he').innerText = BRL(totalHE);
    $('c-dsr').innerText = BRL(valDSR);
    $('c-fal').innerText = `- ${BRL(faltas)}`;
    $('c-base').innerText = BRL(bruto);
    $('c-inss').innerText = `- ${BRL(inss)}`;
    $('c-adiant').innerText = `- ${BRL(adiant)}`;
    $('c-liq').innerText = BRL(liq);
    
    return { sal, totalHE, valDSR, faltas, inss, adiant, liq };
}

function calcRescisao() {
    const sal = NUM(DB.config.salario);
    const dataFim = new Date($('resc-data').value);
    const admissao = new Date(DB.config.admissao);
    const motivo = $('resc-motivo').value;
    const saldoFGTS = NUM($('resc-fgts').value);
    const feriasVenc = $('resc-ferias-venc').value === '1';

    if(!sal || isNaN(dataFim.getTime())) return;

    const diasTrab = dataFim.getDate();
    const saldoSal = (sal / 30) * diasTrab;
    
    let aviso = 0, multa = 0;
    if(motivo === 'sjc') {
        const anos = (dataFim - admissao) / (1000 * 60 * 60 * 24 * 365);
        const diasAviso = 30 + (Math.floor(Math.max(0, anos)) * 3);
        aviso = (sal / 30) * Math.min(diasAviso, 90);
        multa = saldoFGTS * 0.4;
    } else if (motivo === 'acordo') {
        aviso = (sal / 30) * 15;
        multa = saldoFGTS * 0.2;
    }

    const mes = dataFim.getMonth() + 1;
    const d13 = (sal / 12) * mes;
    const feriasProp = (sal / 12) * mes * (4/3);
    const feriasVencidasVal = feriasVenc ? (sal * 4/3) : 0;

    const bruto = saldoSal + aviso + d13 + feriasProp + feriasVencidasVal + multa;
    const inss = calcINSS(saldoSal + d13); 

    $('r-saldo').innerText = BRL(saldoSal);
    $('r-aviso').innerText = BRL(aviso);
    $('r-d13').innerText = BRL(d13);
    $('r-ferias').innerText = BRL(feriasProp + feriasVencidasVal);
    $('r-multa').innerText = BRL(multa);
    $('r-inss').innerText = `- ${BRL(inss)}`;
    $('r-total').innerText = BRL(bruto - inss);
}

// --- A√á√ïES DO SERVIDOR ---

async function saveAction(action, payload) {
    const btn = event.target;
    const txt = btn.innerText;
    btn.innerText = '...'; btn.disabled = true;

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action, payload })
        });
        const json = await res.json();
        if(json.status === 'error') throw new Error(json.message);
        
        await initData();
        alert('Salvo com sucesso!');
    } catch(e) {
        alert('Erro: ' + e.message);
    } finally {
        btn.innerText = txt; btn.disabled = false;
    }
}

function savePagamento() {
    const calc = simulaPag();
    const payload = {
        sheet: 'pagamentos',
        data: {
            mes: $('pag-mes').value,
            ano: $('pag-ano').value,
            salarioBase: calc.sal,
            totalHE: calc.totalHE,
            valorDSR: calc.valDSR,
            totalFaltas: calc.faltas,
            valorINSS: calc.inss,
            adiantamento: calc.adiant,
            liquido: calc.liq,
            status: 'Pago'
        }
    };
    if(confirm(`Confirmar pagamento l√≠quido de ${BRL(calc.liq)}?`)) {
        saveAction('save', payload);
    }
}

function saveHE() {
    const min = $('he-min').value;
    const tipo = $('he-tipo').value;
    const val = calcHEValue(min, tipo);
    const payload = {
        sheet: 'horasExtras',
        data: {
            data: $('he-data').value,
            tipo: tipo,
            minutos: min,
            valorEstimado: val,
            motivo: $('he-motivo').value,
            status: 'Pendente'
        }
    };
    saveAction('save', payload);
}

function saveConfig() {
    const payload = {
        nome: $('cfg-nome').value,
        salario: $('cfg-salario').value,
        admissao: $('cfg-admissao').value
    };
    saveAction('updateConfig', payload);
}

function markPaid(sheet, id) {
    if(confirm('Marcar como pago?')) {
        saveAction('markPaid', { sheet, id, status: 'Pago' });
    }
}
</script>
</body>
</html>
