<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gest√£o Dom√©stica Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f2f5; --surface: #ffffff;
    --primary: #0f172a; --accent: #3b82f6;
    --text: #334155; --text-light: #64748b;
    --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
    --border: #e2e8f0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; font-size: 14px; }

  /* LAYOUT */
  aside { width: 260px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
  main { flex: 1; overflow-y: auto; padding: 30px; }
  
  /* NAV & HEADER */
  .brand { padding: 24px; font-size: 18px; font-weight: 800; color: var(--primary); border-bottom: 1px solid var(--border); letter-spacing: -0.5px; }
  .nav-item { display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px 20px; color: var(--text-light); border: none; background: transparent; cursor: pointer; font-weight: 500; transition: 0.2s; text-align: left; margin-bottom: 2px; }
  .nav-item:hover { background: #f1f5f9; color: var(--primary); }
  .nav-item.active { background: #e0f2fe; color: var(--accent); font-weight: 600; border-right: 3px solid var(--accent); }
  
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .page-title { font-size: 24px; font-weight: 700; color: var(--primary); letter-spacing: -0.5px; }

  /* CARDS & GRID */
  .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .card { background: var(--surface); border-radius: 12px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  .card h3 { font-size: 15px; font-weight: 600; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

  /* METRICS */
  .kpi { padding: 20px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); position: relative; overflow: hidden; }
  .kpi-lbl { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-light); margin-bottom: 6px; }
  .kpi-val { font-size: 26px; font-weight: 700; color: var(--primary); letter-spacing: -1px; }
  .kpi-sub { font-size: 13px; margin-top: 4px; color: var(--text-light); }
  .kpi-tag { position: absolute; top: 15px; right: 15px; font-size: 20px; opacity: 0.2; }

  /* FORMS & TABLES */
  .row { display: flex; gap: 15px; margin-bottom: 15px; }
  .row > div { flex: 1; }
  label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text); }
  input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; color: var(--primary); }
  input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
  
  .btn { width: 100%; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #1e293b; }
  .btn-sm { width: auto; padding: 8px 16px; font-size: 13px; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 12px; background: #f8fafc; color: var(--text-light); font-weight: 600; border-bottom: 1px solid var(--border); }
  td { padding: 12px; border-bottom: 1px solid var(--border); color: var(--text); }
  
  .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
  .bg-green { background: #dcfce7; color: #166534; }
  .bg-yellow { background: #fef9c3; color: #854d0e; }

  /* DETALHES FINANCEIROS */
  .fin-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px dashed var(--border); }
  .fin-row:last-child { border-bottom: none; }
  .fin-total { font-weight: 700; font-size: 16px; color: var(--primary); border-top: 2px solid var(--border); margin-top: 10px; padding-top: 10px; border-bottom: none; }
  .text-red { color: var(--danger); }
  .text-blue { color: var(--accent); }
  
  /* ALERTS */
  .alert-box { padding: 12px; border-radius: 6px; font-size: 12px; margin-top: 10px; line-height: 1.4; }
  .alert-warn { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }

  /* UTILS */
  .hidden { display: none !important; }
  #loader, #login { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
</style>
</head>
<body>

<div id="loader" class="hidden"><div style="font-size:30px;animation:spin 1s infinite linear">‚è≥</div><p>Sincronizando...</p></div>
<div id="login">
  <div style="width:360px; text-align:center">
    <h2 style="margin-bottom:10px">üîê Acesso Seguro</h2>
    <p style="color:#64748b; margin-bottom:20px; font-size:13px">Cole a URL do Google Apps Script para conectar.</p>
    <input type="text" id="api-url" placeholder="https://script.google.com/macros/s/..." style="margin-bottom:15px">
    <button class="btn btn-primary" onclick="connect()">Conectar</button>
  </div>
</div>

<aside id="sidebar" class="hidden">
  <div class="brand">üõ°Ô∏è Gest√£o Dom√©stica</div>
  <nav>
    <button class="nav-item active" onclick="nav('dashboard')" data-t="dashboard">üìä Vis√£o Geral</button>
    <button class="nav-item" onclick="nav('pagamentos')" data-t="pagamentos">üí∞ Folha de Pagamento</button>
    <button class="nav-item" onclick="nav('horas')" data-t="horas">‚è±Ô∏è Banco de Horas</button>
    <button class="nav-item" onclick="nav('config')" data-t="config">‚öôÔ∏è Configura√ß√µes</button>
  </nav>
  <div style="margin-top:auto; padding:20px; font-size:11px; color:#94a3b8; text-align:center">
    Sistema Protegido<br>v5.0 (Flex)
    <br><a href="#" onclick="logout()" style="color:var(--danger)">Sair</a>
  </div>
</aside>

<main id="app" class="hidden">

  <div id="view-dashboard" class="view">
    <div class="header">
      <div class="page-title">Painel de Controle</div>
      <button class="btn btn-primary btn-sm" onclick="init()">üîÑ Atualizar</button>
    </div>

    <div class="grid-3">
      <div class="kpi">
        <div class="kpi-lbl">Custo Total (M√™s)</div>
        <div class="kpi-val" id="kpi-custo">R$ 0,00</div>
        <div class="kpi-sub">Sal√°rio + Impostos + HE</div>
        <div class="kpi-tag">üìâ</div>
      </div>
      <div class="kpi">
        <div class="kpi-lbl">Guia DAE Estimada</div>
        <div class="kpi-val" style="color:var(--warning)" id="kpi-dae">R$ 0,00</div>
        <div class="kpi-sub" id="lbl-vencimento">Vence dia 07</div>
        <div class="kpi-tag">üèõÔ∏è</div>
      </div>
      <div class="kpi">
        <div class="kpi-lbl">HE Pendentes</div>
        <div class="kpi-val" id="kpi-he">0</div>
        <div class="kpi-sub" id="kpi-he-val">R$ 0,00</div>
        <div class="kpi-tag">‚è±Ô∏è</div>
      </div>
    </div>

    <div class="card">
      <h3>üìã Detalhamento Financeiro (Previs√£o Atual)</h3>
      <div class="grid-2">
        <div>
          <h4 style="font-size:13px; color:var(--text-light); margin-bottom:10px">FUNCION√ÅRIA (A PAGAR)</h4>
          <div class="fin-row"><span>Sal√°rio Base</span><span id="d-sal">R$ 0,00</span></div>
          <div class="fin-row"><span>+ Horas Extras</span><span id="d-he">R$ 0,00</span></div>
          <div class="fin-row"><span>+ Reflexo DSR</span><span id="d-dsr">R$ 0,00</span></div>
          <div class="fin-row text-red"><span>- INSS (Retido)</span><span id="d-inss">R$ 0,00</span></div>
          <div class="fin-row text-red"><span>- IRRF (Retido)</span><span id="d-irrf">R$ 0,00</span></div>
          <div class="fin-row fin-total"><span>L√≠quido:</span><span id="d-pagar">R$ 0,00</span></div>
        </div>
        <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px dashed var(--border)">
          <h4 style="font-size:13px; color:var(--text-light); margin-bottom:10px">GOVERNO (GUIA DAE/GPS)</h4>
          <div class="fin-row"><span>FGTS (8%)</span><span id="d-fgts">R$ 0,00</span></div>
          <div class="fin-row"><span>FGTS Multa (3.2%)</span><span id="d-fgts-comp" title="Antecipa√ß√£o de Multa">R$ 0,00</span></div>
          <div class="fin-row"><span>INSS Patronal (8%)</span><span id="d-patr">R$ 0,00</span></div>
          <div class="fin-row"><span>Seguro (0.8%)</span><span id="d-gilrat">R$ 0,00</span></div>
          <div class="fin-row text-blue"><span>+ Repasse INSS Func.</span><span id="d-rep-inss">R$ 0,00</span></div>
          <div class="fin-row fin-total" style="color:var(--warning)"><span>Total Guia:</span><span id="d-total-dae">R$ 0,00</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="view-pagamentos" class="view hidden">
    <div class="header"><div class="page-title">Folha de Pagamento</div></div>
    
    <div class="grid-2">
      <div class="card">
        <h3>Lan√ßar M√™s</h3>
        <div class="row">
          <div><label>M√™s</label><select id="p-mes"><option value="1">Jan</option><option value="2">Fev</option><option value="3">Mar</option><option value="4">Abr</option><option value="5">Mai</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Ago</option><option value="9">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select></div>
          <div><label>Ano</label><input type="number" id="p-ano" value="2026"></div>
        </div>
        <div class="row">
          <div><label>HE 50% (min)</label><input type="number" id="p-h50" value="0" oninput="simula()"></div>
          <div><label>HE 100% (min)</label><input type="number" id="p-h100" value="0" oninput="simula()"></div>
        </div>
        <div class="row">
          <div><label>Dias √öteis</label><input type="number" id="p-uteis" value="25" oninput="simula()"></div>
          <div><label>Domingos/Fer</label><input type="number" id="p-dsr" value="5" oninput="simula()"></div>
        </div>
        <div class="row">
          <div><label>Faltas (R$)</label><input type="number" id="p-falta" value="0" step="0.01" oninput="simula()"></div>
          <div><label>Adiantamento (R$)</label><input type="number" id="p-adiant" value="0" step="0.01" oninput="simula()"></div>
        </div>
        <button class="btn btn-primary" onclick="saveFolha()">üíæ Salvar Pagamento</button>
      </div>
      
      <div class="card" style="background:#f1f5f9">
        <h3>Holerite (Pr√©via)</h3>
        <div class="fin-row"><span>Sal√°rio Base</span><span id="h-sal">R$ 0,00</span></div>
        <div class="fin-row"><span>H.Extras + DSR</span><span id="h-he">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- Faltas</span><span id="h-fal">R$ 0,00</span></div>
        <div style="border-bottom:1px solid #ccc; margin:5px 0"></div>
        <div class="fin-row"><span>Base de C√°lculo</span><span id="h-base" style="font-weight:bold">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- INSS</span><span id="h-inss">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- IRRF</span><span id="h-irrf">R$ 0,00</span></div>
        <div class="fin-row text-red"><span>- Adiantamento</span><span id="h-adiant">R$ 0,00</span></div>
        <div class="fin-row fin-total"><span>L√≠quido:</span><span id="h-liq">R$ 0,00</span></div>
        
        <div class="alert-box alert-warn" id="h-aviso-venc">
           Aten√ß√£o: O vencimento oficial do DAE √© dia 07.
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-top:20px">
      <h3>Hist√≥rico</h3>
      <table id="tb-pag"><thead><tr><th>Data</th><th>Bruto</th><th>Desc.</th><th>L√≠quido</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-horas" class="view hidden">
    <div class="header"><div class="page-title">Banco de Horas</div></div>
    <div class="grid-2">
      <div class="card">
        <h3>Registrar Ponto</h3>
        <div class="row">
          <div><label>Data</label><input type="date" id="he-data"></div>
          <div><label>Minutos</label><input type="number" id="he-min" placeholder="Ex: 60"></div>
        </div>
        <div class="row">
           <div><label>Tipo</label><select id="he-tipo"><option value="50">50% (Normal)</option><option value="100">100% (Dom/Fer)</option></select></div>
        </div>
        <label>Motivo</label><input type="text" id="he-motivo" placeholder="Motivo da hora extra" style="margin-bottom:15px">
        <button class="btn btn-primary" onclick="saveHE()">Registrar Hora Extra</button>
      </div>
      <div class="card">
         <h3>Valores de Refer√™ncia</h3>
         <div class="fin-row"><span>Hora Normal</span><span id="ref-hn">R$ 0,00</span></div>
         <div class="fin-row"><span>Hora 50%</span><span id="ref-h50">R$ 0,00</span></div>
         <div class="fin-row"><span>Hora 100%</span><span id="ref-h100">R$ 0,00</span></div>
      </div>
    </div>
    <div class="card" style="margin-top:20px">
      <h3>Pendentes</h3>
      <table id="tb-he"><thead><tr><th>Data</th><th>Tipo</th><th>Tempo</th><th>Valor</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-config" class="view hidden">
    <div class="header"><div class="page-title">Configura√ß√µes</div></div>
    <div class="card" style="max-width:500px">
       <label>Nome Funcion√°rio</label><input type="text" id="c-nome" style="margin-bottom:15px">
       <label>Sal√°rio Base (R$)</label><input type="number" id="c-sal" step="0.01" style="margin-bottom:15px">
       <label>Data Admiss√£o</label><input type="date" id="c-adm" style="margin-bottom:15px">
       
       <div style="background:#fffbeb; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #e2e8f0">
         <label>Dia de Vencimento (Guia)</label>
         <select id="c-venc">
           <option value="7">Dia 07 (Padr√£o DAE eSocial)</option>
           <option value="20">Dia 20 (GPS/Contabilidade Espec√≠fica)</option>
         </select>
         <p style="font-size:11px; color:#b45309; margin-top:5px">
           *Nota: Se escolher dia 20 para Boleto Unificado (DAE), verifique se h√° cobran√ßa de juros, pois a lei estipula dia 07.
         </p>
       </div>

       <button class="btn btn-primary" onclick="saveConfig()">Salvar Configura√ß√µes</button>
    </div>
  </div>

</main>

<script>
// ============================================
// SISTEMA DE GEST√ÉO DOM√âSTICA - v5.0 (Flexible)
// ============================================

let API = localStorage.getItem('gd_v5_url');
let DB = { config: { vencimento: '7' }, horasExtras: [], pagamentos: [] };
const $ = id => document.getElementById(id);
const BRL = v => Number(v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
const NUM = v => parseFloat(v) || 0;

window.onload = () => {
  $('he-data').value = new Date().toISOString().split('T')[0];
  if(API) { $('api-url').value = API; init(); } 
  else { $('loader').classList.add('hidden'); }
}

function nav(view) {
  document.querySelectorAll('.view').forEach(e => e.classList.add('hidden'));
  $( 'view-' + view ).classList.remove('hidden');
  document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
  document.querySelector(`[data-t="${view}"]`).classList.add('active');
}

function connect() {
  const url = $('api-url').value.trim();
  if(!url) return alert('URL inv√°lida');
  localStorage.setItem('gd_v5_url', url);
  API = url;
  init();
}

function logout() {
  localStorage.removeItem('gd_v5_url');
  location.reload();
}

async function init() {
  $('login').classList.add('hidden');
  $('loader').classList.remove('hidden');
  try {
    const res = await fetch(API, {method:'POST', body:JSON.stringify({action:'init'})});
    const json = await res.json();
    if(json.status === 'error') throw new Error(json.message);
    DB = json;
    // Garante valor padr√£o se vazio
    if(!DB.config.vencimento) DB.config.vencimento = '7';
    
    render();
    $('loader').classList.add('hidden');
    $('sidebar').classList.remove('hidden');
    $('app').classList.remove('hidden');
    nav('dashboard');
  } catch(e) {
    alert('Erro: ' + e.message);
    $('loader').classList.add('hidden');
    $('login').classList.remove('hidden');
  }
}

// --- C√ÅLCULOS 2025 ---

function calcINSS(base) {
  let desc = 0, ant = 0;
  // Tabela Progressiva 2025 (Estimada)
  const faixas = [
    {lim: 1518.00, aliq: 0.075},
    {lim: 2793.88, aliq: 0.09},
    {lim: 4190.83, aliq: 0.12},
    {lim: 8157.41, aliq: 0.14}
  ];
  for(let f of faixas) {
    if(base > ant) {
      let val = Math.min(base, f.lim) - ant;
      desc += val * f.aliq;
      ant = f.lim;
    }
  }
  return Math.min(desc, 951.63);
}

function calcIRRF(base, inss) {
  const baseIR = base - inss; 
  let ir = 0, deducao = 0;
  // Tabela IRRF 2025
  if (baseIR <= 2259.20) return 0;
  else if (baseIR <= 2826.65) { ir = baseIR * 0.075; deducao = 169.44; }
  else if (baseIR <= 3751.05) { ir = baseIR * 0.15; deducao = 381.44; }
  else if (baseIR <= 4664.68) { ir = baseIR * 0.225; deducao = 662.77; }
  else { ir = baseIR * 0.275; deducao = 896.00; }
  return Math.max(0, ir - deducao);
}

function calcDAE(bruto, inssFunc, irrfFunc) {
  const fgts = bruto * 0.08;
  const fgtsComp = bruto * 0.032; 
  const inssPatr = bruto * 0.08;
  const gilrat = bruto * 0.008; 
  const totalGuia = fgts + fgtsComp + inssPatr + gilrat + inssFunc + irrfFunc;
  return { fgts, fgtsComp, inssPatr, gilrat, totalGuia };
}

// --- RENDER ---

function simula() {
  const sal = NUM(DB.config.salario);
  if(!sal) return {};

  const h50 = NUM($('p-h50').value);
  const h100 = NUM($('p-h100').value);
  const uteis = NUM($('p-uteis').value) || 25;
  const dsr = NUM($('p-dsr').value) || 5;
  const falta = NUM($('p-falta').value);
  const adiant = NUM($('p-adiant').value);

  const vH = sal / 220;
  const tHE = (vH * 1.5 * h50/60) + (vH * 2 * h100/60);
  const tDSR = (tHE / uteis) * dsr;
  const bruto = sal + tHE + tDSR - falta;
  
  const inss = calcINSS(bruto);
  const irrf = calcIRRF(bruto, inss);
  const liq = bruto - inss - irrf - adiant;
  const dae = calcDAE(bruto, inss, irrf);

  $('h-sal').innerText = BRL(sal);
  $('h-he').innerText = BRL(tHE + tDSR);
  $('h-fal').innerText = BRL(falta);
  $('h-base').innerText = BRL(bruto);
  $('h-inss').innerText = `- ${BRL(inss)}`;
  $('h-irrf').innerText = `- ${BRL(irrf)}`;
  $('h-adiant').innerText = `- ${BRL(adiant)}`;
  $('h-liq').innerText = BRL(liq);
  
  // Atualiza aviso de vencimento conforme configura√ß√£o
  const diaVenc = DB.config.vencimento || '7';
  if(diaVenc === '20') {
    $('h-aviso-venc').innerHTML = `Configurado para <strong>Dia 20</strong>. <br>Verifique se sua contabilidade incluiu juros ou se √© pagamento via GPS (Sem FGTS).`;
    $('h-aviso-venc').style.borderColor = '#f97316';
  } else {
    $('h-aviso-venc').innerHTML = `Vencimento do DAE: <strong>Dia 07</strong> (Padr√£o Legal)`;
    $('h-aviso-venc').style.borderColor = '#10b981';
  }

  return { sal, tHE, tDSR, bruto, inss, irrf, liq, dae, falta, adiant };
}

function updateDashboard(pendentes) {
  const sal = NUM(DB.config.salario);
  if(!sal) return;
  
  let min50 = 0, min100 = 0;
  pendentes.forEach(h => {
    if(String(h.tipo).includes('100')) min100 += NUM(h.minutos);
    else min50 += NUM(h.minutos);
  });
  
  const vH = sal / 220;
  const heVal = (vH * 1.5 * min50/60) + (vH * 2 * min100/60);
  const dsrVal = (heVal / 25) * 5; 
  const bruto = sal + heVal + dsrVal;
  const inss = calcINSS(bruto);
  const irrf = calcIRRF(bruto, inss);
  const liq = bruto - inss - irrf;
  const dae = calcDAE(bruto, inss, irrf);

  $('kpi-custo').innerText = BRL(liq + dae.totalGuia);
  $('kpi-dae').innerText = BRL(dae.totalGuia);
  $('kpi-he').innerText = pendentes.length;
  $('kpi-he-val').innerText = `Passivo: ${BRL(heVal)}`;
  
  const diaVenc = DB.config.vencimento || '7';
  $('lbl-vencimento').innerText = `Vence dia ${diaVenc}`;

  $('d-sal').innerText = BRL(sal);
  $('d-he').innerText = BRL(heVal);
  $('d-dsr').innerText = BRL(dsrVal);
  $('d-inss').innerText = `- ${BRL(inss)}`;
  $('d-irrf').innerText = `- ${BRL(irrf)}`;
  $('d-pagar').innerText = BRL(liq);

  $('d-fgts').innerText = BRL(dae.fgts);
  $('d-fgts-comp').innerText = BRL(dae.fgtsComp);
  $('d-patr').innerText = BRL(dae.inssPatr);
  $('d-gilrat').innerText = BRL(dae.gilrat);
  $('d-rep-inss').innerText = `+ ${BRL(inss)}`;
  $('d-total-dae').innerText = BRL(dae.totalGuia);
}

function render() {
  $('c-nome').value = DB.config.nome || '';
  $('c-sal').value = DB.config.salario || '';
  $('c-adm').value = DB.config.admissao || '';
  $('c-venc').value = DB.config.vencimento || '7';
  
  const sal = NUM(DB.config.salario);
  $('ref-hn').innerText = BRL(sal/220);
  $('ref-h50').innerText = BRL((sal/220)*1.5);
  $('ref-h100').innerText = BRL((sal/220)*2);

  const pendentes = DB.horasExtras.filter(h => h.status !== 'Pago');
  updateDashboard(pendentes);
  
  const tbHe = $('tb-he').querySelector('tbody');
  tbHe.innerHTML = '';
  pendentes.reverse().forEach(h => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${h.data}</td><td><span class="badge bg-yellow">${h.tipo}%</span></td><td>${h.minutos}m</td><td>${BRL(h.valorEstimado)}</td><td>${h.status}</td><td><button class="btn btn-sm btn-primary" onclick="markPaid('horasExtras','${h.id}')">Pago</button></td>`;
    tbHe.appendChild(tr);
  });

  const tbPag = $('tb-pag').querySelector('tbody');
  tbPag.innerHTML = '';
  DB.pagamentos.slice().reverse().forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.mes}/${p.ano}</td><td>${BRL(NUM(p.salarioBase)+NUM(p.totalHE)+NUM(p.valorDSR))}</td><td style="color:#ef4444">- ${BRL(NUM(p.valorINSS))}</td><td style="font-weight:bold">${BRL(p.liquido)}</td><td><span class="badge bg-green">Pago</span></td>`;
    tbPag.appendChild(tr);
  });
  simula();
}

async function apiCall(action, payload) {
  const btn = event.target;
  const txt = btn.innerText;
  btn.innerText = '...'; btn.disabled = true;
  try {
    const res = await fetch(API, {method:'POST', body:JSON.stringify({action, payload})});
    const j = await res.json();
    if(j.status === 'error') throw new Error(j.message);
    await init();
    alert('Salvo com sucesso!');
  } catch(e) { alert(e.message); } 
  finally { btn.innerText = txt; btn.disabled = false; }
}

function saveConfig() {
  apiCall('updateConfig', {
    nome: $('c-nome').value,
    salario: $('c-sal').value,
    admissao: $('c-adm').value,
    vencimento: $('c-venc').value // Salva a prefer√™ncia
  });
}

function saveHE() {
  const min = $('he-min').value;
  const tipo = $('he-tipo').value;
  const sal = NUM(DB.config.salario);
  const val = (sal/220) * (String(tipo).includes('100')?2:1.5) * (min/60);
  apiCall('save', { sheet: 'horasExtras', data: { data: $('he-data').value, tipo, minutos: min, valorEstimado: val, motivo: $('he-motivo').value, status: 'Pendente' } });
}

function saveFolha() {
  const s = simula();
  if(!s.sal) return;
  if(confirm(`Confirmar L√≠quido: ${BRL(s.liq)}?`)) {
    apiCall('save', { sheet: 'pagamentos', data: { mes: $('p-mes').value, ano: $('p-ano').value, salarioBase: s.sal, totalHE: s.tHE, valorDSR: s.tDSR, valorINSS: s.inss, liquido: s.liq, status: 'Pago' } });
  }
}
function markPaid(sheet, id) { if(confirm('Confirmar?')) apiCall('markPaid', {sheet, id, status:'Pago'}); }
</script>
</body>
</html>
